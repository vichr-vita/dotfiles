Neovim Configuration Review
==========================

Date: 2026-01-18
Repository: /Users/vitchrubasik/dotfiles/nvim/.config/nvim

This document captures the configuration analysis produced by the assistant. Keep this file as a short, actionable checklist for follow-up changes.

1 — High-level overview
-----------------------
- Entry point: `init.lua`
- User modules: `lua/vichr/` (config/ and plugins/)
- Plugin manager: `lazy.nvim` with `lazy-lock.json`
- Total Lua plugin files: ~39 (plus `init.lua` and config modules)

2 — Critical issues (fix ASAP)
-----------------------------
- DONE Deprecated API: `vim.loop.fs_stat()` used in `init.lua` — replace with `vim.uv.fs_stat()`.
- DONE Completion confusion: both `nvim-cmp` (enabled) and `blink-cmp` (disabled) exist; LSP uses `cmp_nvim_lsp` capabilities but `blink` is referenced as dependency — choose one and align LSP capabilities.
- DONE Duplicate plugin registration: `autoformat.lua` re-registers `neovim/nvim-lspconfig` with an empty config — remove duplicate.
- Unsafe project config loading: `telescope.lua` uses `dofile()` without `pcall` — wrap in `pcall(dofile, ...)`.

3 — Important improvements
--------------------------
- Missing `pcall` protection around `require()`/`dofile()` in multiple plugin configs (telescope, LSP, conform usage). Add `pcall` checks.
- Swap deprecated keymap API (`vim.api.nvim_set_keymap`) to `vim.keymap.set` in at least 5 files (copilot.lua, lsp_config.lua, zen-mode.lua, twilight.lua, lazygit.lua).
- Add `desc` to keymaps to populate which-key menus for ~7 maps currently missing descriptions.
- Aggressive lazy-loading: many plugins load eagerly. Candidate plugins to lazy-load: dadbod suite (on `cmd`), ledger (on `ft`), rainbox-csv (on `ft`), lazygit (on `cmd`), zen-mode/twilight (on `cmd`).
- Remove or delete disabled plugins/configs if not used (e.g., `blink-cmp.lua`, `debug.lua`).

4 — Polish & cleanup
---------------------
- Remove large commented blocks and stale code (cmp, telescope, catppuccin, null-ls, etc.).
- Consolidate icon providers — avoid both `vim-devicons` and `mini.icons` unless intentionally using both.
- Deduplicate dependencies (e.g., `cmp-nvim-lsp` listed twice in one spec).
- Replace hardcoded paths with top-of-file variables for maintainability.

5 — Suggested prioritized next steps
-----------------------------------
1. Fix deprecated API in `init.lua` (`vim.loop` -> `vim.uv`).
2. Decide which completion plugin to keep:
   - Keep `nvim-cmp` and remove `blink-cmp` (recommended), then ensure `lsp_config.lua` uses `cmp_nvim_lsp` capabilities.
   - Or enable `blink-cmp` and update LSP capabilities appropriately.
3. Remove `autoformat.lua` or merge its intent into the main LSP config to avoid duplicate registrations.
4. Add `pcall` guards for risky `require`/`dofile` calls (example in `telescope.lua`).
5. Replace `vim.api.nvim_set_keymap` usages with `vim.keymap.set` and add `desc` fields.
6. Lazy-load obvious non-startup plugins by adding `cmd`, `ft`, or `event` to their lazy spec.

6 — Verification steps
----------------------
- Run formatter: `stylua .` from the repo root to ensure style consistency.
- Start Neovim and check startup messages: open `nvim` and run `:messages`.
- Manually test keymap-related which-key entries and LSP attach/formatting behavior.
- Use `:Lazy log` or `:Lazy health` to inspect plugin load behavior.

7 — Example commit message
--------------------------
"fix(neovim): replace deprecated vim.loop, remove duplicate plugins, add pcall guards, modernize keymaps"

8 — File references
-------------------
- `init.lua`
- `lua/vichr/plugins/cmp.lua`
- `lua/vichr/plugins/blink-cmp.lua`
- `lua/vichr/plugins/autoformat.lua`
- `lua/vichr/plugins/telescope.lua`
- `lua/vichr/config/lsp_config.lua`

9 — Next actions (choose one)
-----------------------------
1) Done — replaced `vim.loop` usage with a `vim.uv` compatibility guard in `init.lua`; changes committed on branch: master (commit 5360294). (completed)
2) I will only apply the minimal critical fixes.
3) I will perform a full polish pass (style, lazy-loading, cleanup).

If you pick 1 or 3 I will make the edits, run `stylua .`, and present the diffs for review. If you prefer 2 I will only change the deprecated API, remove duplicates, and add pcall to the unsafe `dofile`.


---
This file was generated by the assistant to capture the configuration review. Keep it at `NEOVIM_CONFIG_REVIEW.md` for reference.

10 — Highest-priority task and implementation plan
--------------------------------------------------
- Decision (highest priority): Consolidate completion system by keeping `nvim-cmp` and removing `blink-cmp`. This reduces confusion, ensures LSP capabilities align with the active completion source, and avoids duplicate or conflicting completion behavior. (Recommended)

- Why this first: Completion and LSP capability mismatches directly affect everyday editing (completions, snippets, LSP features). Fixing this reduces user friction immediately and prevents follow-up churn when modernizing LSP config or other plugins.

- Scope: Remove `blink-cmp` plugin/config, confirm `nvim-cmp` is configured and enabled, update `lua/vichr/config/lsp_config.lua` to ensure capabilities use `cmp_nvim_lsp`, remove `blink` references from other plugin specs, run formatter, and verify runtime behavior.

- Files to change:
  - `lua/vichr/plugins/blink-cmp.lua` — remove or delete this file.
  - `lua/vichr/plugins/cmp.lua` — ensure it is enabled and has desired sources/snippet support.
  - `lua/vichr/config/lsp_config.lua` — confirm or add the following pattern when building capabilities:

    ```lua
    local cmp_nvim_lsp_ok, cmp_nvim_lsp = pcall(require, 'cmp_nvim_lsp')
    local capabilities = vim.lsp.protocol.make_client_capabilities()
    if cmp_nvim_lsp_ok then
      capabilities = cmp_nvim_lsp.default_capabilities(capabilities)
    end
    -- use `capabilities` in lsp setup
    ```

  - Any plugin specs referencing `blink` as a dependency — remove `blink` from `dependencies` and from `lazy-lock.json` if present (the lock file will update after `:Lazy sync` or re-resolving).

- Implementation steps (sequential):
  1. Delete `lua/vichr/plugins/blink-cmp.lua` (or move to a disabled/archived folder if you want to keep it).
  2. Open `lua/vichr/plugins/cmp.lua` and verify it is enabled. Confirm sources, snippet engine (luasnip or vscode), and mappings are set. Add `event = 'InsertEnter'` or other lazy trigger if desired.
  3. Update `lua/vichr/config/lsp_config.lua` to use `cmp_nvim_lsp.default_capabilities` as shown above, wrapped in `pcall`.
  4. Remove `blink` references from any other plugin specs (search for `blink` and update specs).
  5. Run `stylua .` to format changes.
  6. Start Neovim and run `:Lazy sync` (if you removed a plugin) and `:messages` to check for errors.
  7. Verify completion works: open a file with a language server attached, trigger completion (insert mode + `<C-Space>` or as configured), confirm LSP suggestions appear and snippets expand correctly.
  8. Run `:Lazy log` / `:Lazy health` and sanity-check that `cmp` loads and `blink` is not present.

- Verification checklist:
  - `blink` is not in `lua/vichr/plugins/` and no active plugin spec references it.
  - `lsp_config.lua` uses `cmp_nvim_lsp` capabilities (with `pcall`).
  - `stylua .` completes with no changes needed or only formatting fixes already applied.
  - Neovim starts without startup errors; completion works for at least one LSP-backed file.

- Estimated effort: 15–30 minutes (quick edits + local verification).

- Suggested commit message:
  "chore(neovim): consolidate completion to nvim-cmp, remove blink-cmp, align LSP capabilities"

- Next options (choose one):
  1) I should make these edits and present the diffs for review.
  2) I should make the edits, run `stylua .`, and commit the changes locally (I will not push unless you ask).
  3) Just produce the patch/diff and stop (you will apply it yourself).

Choose 1, 2, or 3 and I will proceed.
